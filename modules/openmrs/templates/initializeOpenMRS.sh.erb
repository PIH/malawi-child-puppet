#!/bin/bash

# ====================================================================================
echo "Set Db connection properties"
# ====================================================================================

LOGFILE=`pwd`/$$.log
exec > $LOGFILE 2>&1

OPENMRS_USER=<%= @openmrs_user %>
MYSQL_CLIENT="mysql"
TOMCAT_START="sudo service tomcat6 start"

LOCAL_OPENMRS_DB_USER=root
LOCAL_OPENMRS_DB_PASSWORD=<%= @mysql_root_password %>
LOCAL_DB_CREDENTIALS="-u $LOCAL_OPENMRS_DB_USER -p$LOCAL_OPENMRS_DB_PASSWORD"
OPENMRS_DB=<%= @openmrs_db %>

DROP_AND_CREATE_DB_SCRIPT=<%= @openmrs_create_db_sql %>
OPENMRS_DUMP_SQL=<%= @openmrs_dump_sql %>
DELETE_SYNC_TABLES_DB_SCRIPT=<%= @delete_sync_tables_sql %>
UPDATE_CHILD_SERVER_DB_SCRIPT=<%= @update_child_server_settings_sql %>
UPDATE_PARENT_SERVER_DB_SCRIPT=<%= @update_parent_server_settings_sql %>

PARENT_SERVER=<%= @ssh_parent_address %>
SSH_USER=<%= @ssh_user %>
SSH_KEY=<%= @ssh_key %>
SSH_PORT=<%= @ssh_port %>
SCP_CREDENTIALS="-P $SSH_PORT -i $SSH_KEY" 
SSH_CREDENTIALS="-i $SSH_KEY $SSH_USER@$PARENT_SERVER -p $SSH_PORT"
CONNECT_TO_SERVER="ssh $SSH_CREDENTIALS"

OPENMRS_DB_REMOTE=<%= @openmrs_db_remote %>
REMOTE_OPENMRS_DB_USER=<%= @parent_mysql_root_user %>
REMOTE_OPENMRS_DB_PASSWORD=<%= @parent_mysql_db_password %>
REMOTE_DB_CREDENTIALS="-u $REMOTE_OPENMRS_DB_USER -p$REMOTE_OPENMRS_DB_PASSWORD $OPENMRS_DB_REMOTE"
REMOTE_DB_CONNECTION="mysql $REMOTE_DB_CREDENTIALS"

SERVER_UUID_TEXT_FILE=<%= @server_uuid_text_file %>
CATALINA_LOG="/var/lib/tomcat6/logs/catalina.out"
SUDOLOGFILE=sudo.log

echo Ensure has permissions to execute files
sudo grep $OPENMRS_USER /etc/sudoers > $SUDOLOGFILE
counter=`wc -l "$SUDOLOGFILE" | awk '{print $1'}`
if [ $counter -eq 0 ]
	then
	sudo sh -c "echo \"$OPENMRS_USER ALL=(root) NOPASSWD: /etc/init.d/tomcat6\" >> /etc/sudoers"
	sudo sh -c "echo \"$OPENMRS_USER ALL=(root) NOPASSWD: <%= @register_child_with_parent_sh %>\" >> /etc/sudoers"
	sudo sh -c "echo \"$OPENMRS_USER ALL=(root) NOPASSWD: <%= @prepare_child_server_sh %>\" >> /etc/sudoers"
fi

# drop and recreate local DB 
echo "Drop and re-create local DB"
$MYSQL_CLIENT $LOCAL_DB_CREDENTIALS < $DROP_AND_CREATE_DB_SCRIPT
if [ "$?" = "0" ]; then
	echo "OpenMRS db has been recreated"
else
	echo "Failed to recreate the OpenMRS DB" 1>&2
	exit 1
fi

# import parent db into the local server 
echo "Import parent DB"
$MYSQL_CLIENT $LOCAL_DB_CREDENTIALS $OPENMRS_DB < $OPENMRS_DUMP_SQL
if [ "$?" = "0" ]; then
	echo "OpenMRS db has been imported"
else
	echo "Failed to import OpenMRS DB" 1>&2
	exit 1
fi

# delete sync tables from the local server 
echo "Delete sync tables"
$MYSQL_CLIENT $LOCAL_DB_CREDENTIALS $OPENMRS_DB < $DELETE_SYNC_TABLES_DB_SCRIPT
if [ "$?" = "0" ]; then
	echo "sync tables have been deleted"
else
	echo "Failed to delete sync tables" 1>&2
	exit 1
fi

# Start Tomcat
echo Start Tomcat openmrs web app
$TOMCAT_START

#counter=`grep "Server startup" $CATALINA_LOG | wc -l | awk '{print $1'}`
echo Waiting for Tomcat to start
#while [ $counter -eq 0 ]
#	do
# 	sleep 2s
#	counter=`grep "Server startup" $CATALINA_LOG | wc -l | awk '{print $1'}`
#done
sleep 360s

if [ -f "$SERVER_UUID_TEXT_FILE" ]
then
	echo Temporary UUID file exists, removing...
	sudo rm $SERVER_UUID_TEXT_FILE
fi

#CONFIGURE_CHILD_SETTINGS
echo Configure sync child server
$MYSQL_CLIENT $LOCAL_DB_CREDENTIALS $OPENMRS_DB < $UPDATE_CHILD_SERVER_DB_SCRIPT
if [ $? -ne 0 ] 
	then
	echo Error configuring child server
	exit 1
fi

#UPLOAD_CHILD_SERVER_UUID
echo Upload child server UUID text file to the parent server
scp $SCP_CREDENTIALS $SERVER_UUID_TEXT_FILE $SSH_USER@$PARENT_SERVER:/tmp/
if [ $? -ne 0 ] 
then
echo Error uploading child server uuid text file to parent /tmp/ folder
exit 1
fi

echo Configure sync parent server
$CONNECT_TO_SERVER $REMOTE_DB_CONNECTION < $UPDATE_PARENT_SERVER_DB_SCRIPT
if [ $? -ne 0 ] 
then
echo Error configuring parent server
exit 1
fi

rm $SERVER_UUID_TEXT_FILE
